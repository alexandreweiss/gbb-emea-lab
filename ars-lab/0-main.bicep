param location string = 'westeurope'

module hub '../_modules/vnetMultiSubnets.bicep' = {
  name: 'hub'
  params: {
    addressSpace: '172.20.20.0/24'
    location: location
    subnets: [
      {
        name: 'RouteServerSubnet'
        addressPrefix: '172.20.20.0/27'
      }
      {
        name: 'AzureBastionSubnet'
        addressPrefix: '172.20.20.32/27'
      }
      {
        name: 'default'
        addressPrefix: '172.20.20.64/28'
      }
    ]
    vnetName: 'hub'
  }
}

module spoke1 '../_modules/vnet.bicep' = {
  name: 'spoke1'
  params: {
    addressPrefix: '172.20.21.0/28'
    addressSpace: '172.20.21.0/24'
    location: location
    vnetName: 'spoke1'
  }
}

module spoke2 '../_modules/vnet.bicep' = {
  name: 'spoke2'
  params: {
    addressPrefix: '172.20.22.0/28'
    addressSpace: '172.20.22.0/24'
    location: location
    vnetName: 'spoke2'
  }
}

resource peeringHubSpoke1 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2021-02-01' = {
  name: '${hub.name}/hubToSpoke1'
  properties: {
    remoteVirtualNetwork: {
      id: spoke1.outputs.vnetId
    }
  }
}

resource peeringSpoke1Hub 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2021-02-01' = {
  name: '${spoke1.name}/spoke1ToHub'
  properties: {
    remoteVirtualNetwork: {
      id: hub.outputs.vnetId
    }
  }
}

resource peeringHubSpoke2 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2021-02-01' = {
  name: '${hub.name}/hubToSpoke2'
  properties: {
    remoteVirtualNetwork: {
      id: spoke2.outputs.vnetId
    }
  }
}

resource peeringSpoke2Hub 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2021-02-01' = {
  name: '${spoke2.name}/spoke1ToHub'
  properties: {
    remoteVirtualNetwork: {
      id: hub.outputs.vnetId
    }
  }
}

module routeServer '../_modules/ars.bicep' = {
  name: 'ars'
  params: {
    location:location
    name: 'ars'
    enableB2b: false
    subnetId: hub.outputs.subnets[0].id
    peer1Asn: 65001
    peer1Ip: spoke1Vm.outputs.nicPrivateIp
    peer2Asn: 65002
    peer2Ip: spoke2Vm.outputs.nicPrivateIp
  }
}

module spoke1Vm '../_modules/vm.bicep' = {
  name: 'spoke1Vm'
  params: {
    location: location
    subnetId: spoke1.outputs.subnetId
    vmName: 'spoke1Vm'
    enableForwarding: true
    enableCloudInit: true
    cloudInitValue: 'IyEvYmluL2Jhc2gKCiMjIE5PVEU6CiMjIGJlZm9yZSBydW5uaW5nIHRoZSBzY3JpcHQsIGN1c3RvbWl6ZSB0aGUgdmFsdWVzIG9mIHZhcmlhYmxlcyBzdWl0YWJsZSBmb3IgeW91ciBkZXBsb3ltZW50LiAKIyMgYXNuX3F1YWdnYTogQXV0b25vbW91cyBzeXN0ZW0gbnVtYmVyIGFzc2lnbmVkIHRvIHF1YWdnYQojIyBiZ3Bfcm91dGVySWQ6IElQIGFkZHJlc3Mgb2YgcXVhZ2dhIFZNCiMjIGJncF9uZXR3b3JrMTogZmlyc3QgbmV0d29yayBhZHZlcnRpc2VkIGZyb20gcXVhZ2dhIHRvIHRoZSByb3V0ZXIgc2VydmVyIChpbmNsdXNpdmUgb2Ygc3VibmV0bWFzaykKIyMgYmdwX25ldHdvcmsyOiBzZWNvbmQgbmV0d29yayBhZHZlcnRpc2VkIGZyb20gcXVhZ2dhIHRvIHRoZSByb3V0ZXIgc2VydmVyIChpbmNsdXNpdmUgb2Ygc3VibmV0bWFzaykKIyMgYmdwX25ldHdvcmszOiB0aGlyZCBuZXR3b3JrIGFkdmVydGlzZWQgZnJvbSBxdWFnZ2EgdG8gdGhlIHJvdXRlciBzZXJ2ZXIgKGluY2x1c2l2ZSBvZiBzdWJuZXRtYXNrKQojIyByb3V0ZXNlcnZlcl9JUDE6IGZpcnN0IElQIGFkZHJlc3Mgb2YgdGhlIHJvdXRlciBzZXJ2ZXIgCiMjIHJvdXRlc2VydmVyX0lQMjogc2Vjb25kIElQIGFkZHJlc3Mgb2YgdGhlIHJvdXRlciBzZXJ2ZXIKCmFzbl9xdWFnZ2E9NjUwMDEKYmdwX3JvdXRlcklkPTE3Mi4yMC4yMS40CmJncF9uZXR3b3JrMT0xNzIuMjAuMjEuMC8yNApyb3V0ZXNlcnZlcl9JUDE9MTcyLjIwLjIwLjQKcm91dGVzZXJ2ZXJfSVAyPTE3Mi4yMC4yMC41CgoKc3VkbyBhcHQtZ2V0IC15IHVwZGF0ZQoKIyMgSW5zdGFsbCB0aGUgUXVhZ2dhIHJvdXRpbmcgZGFlbW9uCmVjaG8gIkluc3RhbGxpbmcgcXVhZ2dhIgpzdWRvIGFwdC1nZXQgLXkgaW5zdGFsbCBxdWFnZ2EKCiMjICBydW4gdGhlIHVwZGF0ZXMgYW5kIGVuc3VyZSB0aGUgcGFja2FnZXMgYXJlIHVwIHRvIGRhdGUgYW5kIHRoZXJlIGlzIG5vIG5ldyB2ZXJzaW9uIGF2YWlsYWJsZSBmb3IgdGhlIHBhY2thZ2VzCnN1ZG8gYXB0LWdldCAteSB1cGRhdGUgLS1maXgtbWlzc2luZwoKIyMgRW5hYmxlIElQdjQgZm9yd2FyZGluZwplY2hvICJuZXQuaXB2NC5jb25mLmFsbC5mb3J3YXJkaW5nPTEiIHwgc3VkbyB0ZWUgLWEgL2V0Yy9zeXNjdGwuY29uZiAKZWNobyAibmV0LmlwdjQuY29uZi5kZWZhdWx0LmZvcndhcmRpbmc9MSIgfCBzdWRvIHRlZSAtYSAvZXRjL3N5c2N0bC5jb25mIApzeXNjdGwgLXAKCiMjIENyZWF0ZSBhIGZvbGRlciBmb3IgdGhlIHF1YWdnYSBsb2dzCmVjaG8gImNyZWF0aW5nIGZvbGRlciBmb3IgcXVhZ2dhIGxvZ3MiCnN1ZG8gbWtkaXIgLXAgL3Zhci9sb2cvcXVhZ2dhICYmIHN1ZG8gY2hvd24gcXVhZ2dhOnF1YWdnYSAvdmFyL2xvZy9xdWFnZ2EKc3VkbyB0b3VjaCAvdmFyL2xvZy96ZWJyYS5sb2cKc3VkbyBjaG93biBxdWFnZ2E6cXVhZ2dhIC92YXIvbG9nL3plYnJhLmxvZwoKIyMgQ3JlYXRlIHRoZSBjb25maWd1cmF0aW9uIGZpbGVzIGZvciBRdWFnZ2EgZGFlbW9uCmVjaG8gImNyZWF0aW5nIGVtcHR5IHF1YWdnYSBjb25maWcgZmlsZXMiCnN1ZG8gdG91Y2ggL2V0Yy9xdWFnZ2EvYmFiZWxkLmNvbmYKc3VkbyB0b3VjaCAvZXRjL3F1YWdnYS9iZ3BkLmNvbmYKc3VkbyB0b3VjaCAvZXRjL3F1YWdnYS9pc2lzZC5jb25mCnN1ZG8gdG91Y2ggL2V0Yy9xdWFnZ2Evb3NwZjZkLmNvbmYKc3VkbyB0b3VjaCAvZXRjL3F1YWdnYS9vc3BmZC5jb25mCnN1ZG8gdG91Y2ggL2V0Yy9xdWFnZ2EvcmlwZC5jb25mCnN1ZG8gdG91Y2ggL2V0Yy9xdWFnZ2EvcmlwbmdkLmNvbmYKc3VkbyB0b3VjaCAvZXRjL3F1YWdnYS92dHlzaC5jb25mCnN1ZG8gdG91Y2ggL2V0Yy9xdWFnZ2EvemVicmEuY29uZgoKIyMgQ2hhbmdlIHRoZSBvd25lcnNoaXAgYW5kIHBlcm1pc3Npb24gZm9yIGNvbmZpZ3VyYXRpb24gZmlsZXMsIHVuZGVyIC9ldGMvcXVhZ2dhIGZvbGRlcgplY2hvICJhc3NpZ24gdG8gcXVhZ2dhIHVzZXIgdGhlIG93bmVyc2hpcCBvZiBjb25maWcgZmlsZXMiCnN1ZG8gY2hvd24gcXVhZ2dhOnF1YWdnYSAvZXRjL3F1YWdnYS9iYWJlbGQuY29uZiAmJiBzdWRvIGNobW9kIDY0MCAvZXRjL3F1YWdnYS9iYWJlbGQuY29uZgpzdWRvIGNob3duIHF1YWdnYTpxdWFnZ2EgL2V0Yy9xdWFnZ2EvYmdwZC5jb25mICYmIHN1ZG8gY2htb2QgNjQwIC9ldGMvcXVhZ2dhL2JncGQuY29uZgpzdWRvIGNob3duIHF1YWdnYTpxdWFnZ2EgL2V0Yy9xdWFnZ2EvaXNpc2QuY29uZiAmJiBzdWRvIGNobW9kIDY0MCAvZXRjL3F1YWdnYS9pc2lzZC5jb25mCnN1ZG8gY2hvd24gcXVhZ2dhOnF1YWdnYSAvZXRjL3F1YWdnYS9vc3BmNmQuY29uZiAmJiBzdWRvIGNobW9kIDY0MCAvZXRjL3F1YWdnYS9vc3BmNmQuY29uZgpzdWRvIGNob3duIHF1YWdnYTpxdWFnZ2EgL2V0Yy9xdWFnZ2Evb3NwZmQuY29uZiAmJiBzdWRvIGNobW9kIDY0MCAvZXRjL3F1YWdnYS9vc3BmZC5jb25mCnN1ZG8gY2hvd24gcXVhZ2dhOnF1YWdnYSAvZXRjL3F1YWdnYS9yaXBkLmNvbmYgJiYgc3VkbyBjaG1vZCA2NDAgL2V0Yy9xdWFnZ2EvcmlwZC5jb25mCnN1ZG8gY2hvd24gcXVhZ2dhOnF1YWdnYSAvZXRjL3F1YWdnYS9yaXBuZ2QuY29uZiAmJiBzdWRvIGNobW9kIDY0MCAvZXRjL3F1YWdnYS9yaXBuZ2QuY29uZgpzdWRvIGNob3duIHF1YWdnYTpxdWFnZ2F2dHkgL2V0Yy9xdWFnZ2EvdnR5c2guY29uZiAmJiBzdWRvIGNobW9kIDY2MCAvZXRjL3F1YWdnYS92dHlzaC5jb25mCnN1ZG8gY2hvd24gcXVhZ2dhOnF1YWdnYSAvZXRjL3F1YWdnYS96ZWJyYS5jb25mICYmIHN1ZG8gY2htb2QgNjQwIC9ldGMvcXVhZ2dhL3plYnJhLmNvbmYKCiMjIGluaXRpYWwgc3RhcnR1cCBjb25maWd1cmF0aW9uIGZvciBRdWFnZ2EgZGFlbW9ucyBhcmUgcmVxdWlyZWQKZWNobyAiU2V0dGluZyB1cCBkYWVtb24gc3RhcnR1cCBjb25maWciCmVjaG8gJ3plYnJhPXllcycgPiAvZXRjL3F1YWdnYS9kYWVtb25zCmVjaG8gJ2JncGQ9eWVzJyA+PiAvZXRjL3F1YWdnYS9kYWVtb25zCmVjaG8gJ29zcGZkPW5vJyA+PiAvZXRjL3F1YWdnYS9kYWVtb25zCmVjaG8gJ29zcGY2ZD1ubycgPj4gL2V0Yy9xdWFnZ2EvZGFlbW9ucwplY2hvICdyaXBkPW5vJyA+PiAvZXRjL3F1YWdnYS9kYWVtb25zCmVjaG8gJ3JpcG5nZD1ubycgPj4gL2V0Yy9xdWFnZ2EvZGFlbW9ucwplY2hvICdpc2lzZD1ubycgPj4gL2V0Yy9xdWFnZ2EvZGFlbW9ucwplY2hvICdiYWJlbGQ9bm8nID4+IC9ldGMvcXVhZ2dhL2RhZW1vbnMKCmVjaG8gImFkZCB6ZWJyYSBjb25maWciCmNhdCA8PEVPRiA+IC9ldGMvcXVhZ2dhL3plYnJhLmNvbmYKIQppbnRlcmZhY2UgZXRoMAohCmludGVyZmFjZSBsbwohCmlwIGZvcndhcmRpbmcKIQpsaW5lIHZ0eQohCkVPRgoKCmVjaG8gImFkZCBxdWFnZ2EgY29uZmlnIgpjYXQgPDxFT0YgPiAvZXRjL3F1YWdnYS9iZ3BkLmNvbmYKIQpyb3V0ZXIgYmdwICRhc25fcXVhZ2dhCiBiZ3Agcm91dGVyLWlkICRiZ3Bfcm91dGVySWQKIG5ldHdvcmsgJGJncF9uZXR3b3JrMQogbmVpZ2hib3IgJHJvdXRlc2VydmVyX0lQMSByZW1vdGUtYXMgNjU1MTUKIG5laWdoYm9yICRyb3V0ZXNlcnZlcl9JUDEgc29mdC1yZWNvbmZpZ3VyYXRpb24gaW5ib3VuZAogbmVpZ2hib3IgJHJvdXRlc2VydmVyX0lQMiByZW1vdGUtYXMgNjU1MTUKIG5laWdoYm9yICRyb3V0ZXNlcnZlcl9JUDIgc29mdC1yZWNvbmZpZ3VyYXRpb24gaW5ib3VuZAohCiBhZGRyZXNzLWZhbWlseSBpcHY2CiBleGl0LWFkZHJlc3MtZmFtaWx5CiBleGl0CiEKbGluZSB2dHkKIQpFT0YKCiMjIHRvIHN0YXJ0IGRhZW1vbnMgYXQgc3lzdGVtIHN0YXJ0dXAKZWNobyAiZW5hYmxlIHplYnJhIGFuZCBxdWFnZ2EgZGFlbW9ucyBhdCBzeXN0ZW0gc3RhcnR1cCIKc3lzdGVtY3RsIGVuYWJsZSB6ZWJyYS5zZXJ2aWNlCnN5c3RlbWN0bCBlbmFibGUgYmdwZC5zZXJ2aWNlCgojIyBydW4gdGhlIGRhZW1vbnMKZWNobyAic3RhcnQgemVicmEgYW5kIHF1YWdnYSBkYWVtb25zIgpzeXN0ZW1jdGwgc3RhcnQgemVicmEgCnN5c3RlbWN0bCBzdGFydCBiZ3BkCg=='
  }
}

module spoke2Vm '../_modules/vm.bicep' = {
  name: 'spoke2Vm'
  params: {
    location: location
    subnetId: spoke2.outputs.subnetId
    vmName: 'spoke2Vm'
    enableForwarding: true
    enableCloudInit: true
    cloudInitValue: 'IyEvYmluL2Jhc2gKCiMjIE5PVEU6CiMjIGJlZm9yZSBydW5uaW5nIHRoZSBzY3JpcHQsIGN1c3RvbWl6ZSB0aGUgdmFsdWVzIG9mIHZhcmlhYmxlcyBzdWl0YWJsZSBmb3IgeW91ciBkZXBsb3ltZW50LiAKIyMgYXNuX3F1YWdnYTogQXV0b25vbW91cyBzeXN0ZW0gbnVtYmVyIGFzc2lnbmVkIHRvIHF1YWdnYQojIyBiZ3Bfcm91dGVySWQ6IElQIGFkZHJlc3Mgb2YgcXVhZ2dhIFZNCiMjIGJncF9uZXR3b3JrMTogZmlyc3QgbmV0d29yayBhZHZlcnRpc2VkIGZyb20gcXVhZ2dhIHRvIHRoZSByb3V0ZXIgc2VydmVyIChpbmNsdXNpdmUgb2Ygc3VibmV0bWFzaykKIyMgYmdwX25ldHdvcmsyOiBzZWNvbmQgbmV0d29yayBhZHZlcnRpc2VkIGZyb20gcXVhZ2dhIHRvIHRoZSByb3V0ZXIgc2VydmVyIChpbmNsdXNpdmUgb2Ygc3VibmV0bWFzaykKIyMgYmdwX25ldHdvcmszOiB0aGlyZCBuZXR3b3JrIGFkdmVydGlzZWQgZnJvbSBxdWFnZ2EgdG8gdGhlIHJvdXRlciBzZXJ2ZXIgKGluY2x1c2l2ZSBvZiBzdWJuZXRtYXNrKQojIyByb3V0ZXNlcnZlcl9JUDE6IGZpcnN0IElQIGFkZHJlc3Mgb2YgdGhlIHJvdXRlciBzZXJ2ZXIgCiMjIHJvdXRlc2VydmVyX0lQMjogc2Vjb25kIElQIGFkZHJlc3Mgb2YgdGhlIHJvdXRlciBzZXJ2ZXIKCmFzbl9xdWFnZ2E9NjUwMDIKYmdwX3JvdXRlcklkPTE3Mi4yMC4yMi40CmJncF9uZXR3b3JrMT0xNzIuMjAuMjIuMC8yNApyb3V0ZXNlcnZlcl9JUDE9MTcyLjIwLjIwLjQKcm91dGVzZXJ2ZXJfSVAyPTE3Mi4yMC4yMC41CgoKc3VkbyBhcHQtZ2V0IC15IHVwZGF0ZQoKIyMgSW5zdGFsbCB0aGUgUXVhZ2dhIHJvdXRpbmcgZGFlbW9uCmVjaG8gIkluc3RhbGxpbmcgcXVhZ2dhIgpzdWRvIGFwdC1nZXQgLXkgaW5zdGFsbCBxdWFnZ2EKCiMjICBydW4gdGhlIHVwZGF0ZXMgYW5kIGVuc3VyZSB0aGUgcGFja2FnZXMgYXJlIHVwIHRvIGRhdGUgYW5kIHRoZXJlIGlzIG5vIG5ldyB2ZXJzaW9uIGF2YWlsYWJsZSBmb3IgdGhlIHBhY2thZ2VzCnN1ZG8gYXB0LWdldCAteSB1cGRhdGUgLS1maXgtbWlzc2luZwoKIyMgRW5hYmxlIElQdjQgZm9yd2FyZGluZwplY2hvICJuZXQuaXB2NC5jb25mLmFsbC5mb3J3YXJkaW5nPTEiIHwgc3VkbyB0ZWUgLWEgL2V0Yy9zeXNjdGwuY29uZiAKZWNobyAibmV0LmlwdjQuY29uZi5kZWZhdWx0LmZvcndhcmRpbmc9MSIgfCBzdWRvIHRlZSAtYSAvZXRjL3N5c2N0bC5jb25mIApzeXNjdGwgLXAKCiMjIENyZWF0ZSBhIGZvbGRlciBmb3IgdGhlIHF1YWdnYSBsb2dzCmVjaG8gImNyZWF0aW5nIGZvbGRlciBmb3IgcXVhZ2dhIGxvZ3MiCnN1ZG8gbWtkaXIgLXAgL3Zhci9sb2cvcXVhZ2dhICYmIHN1ZG8gY2hvd24gcXVhZ2dhOnF1YWdnYSAvdmFyL2xvZy9xdWFnZ2EKc3VkbyB0b3VjaCAvdmFyL2xvZy96ZWJyYS5sb2cKc3VkbyBjaG93biBxdWFnZ2E6cXVhZ2dhIC92YXIvbG9nL3plYnJhLmxvZwoKIyMgQ3JlYXRlIHRoZSBjb25maWd1cmF0aW9uIGZpbGVzIGZvciBRdWFnZ2EgZGFlbW9uCmVjaG8gImNyZWF0aW5nIGVtcHR5IHF1YWdnYSBjb25maWcgZmlsZXMiCnN1ZG8gdG91Y2ggL2V0Yy9xdWFnZ2EvYmFiZWxkLmNvbmYKc3VkbyB0b3VjaCAvZXRjL3F1YWdnYS9iZ3BkLmNvbmYKc3VkbyB0b3VjaCAvZXRjL3F1YWdnYS9pc2lzZC5jb25mCnN1ZG8gdG91Y2ggL2V0Yy9xdWFnZ2Evb3NwZjZkLmNvbmYKc3VkbyB0b3VjaCAvZXRjL3F1YWdnYS9vc3BmZC5jb25mCnN1ZG8gdG91Y2ggL2V0Yy9xdWFnZ2EvcmlwZC5jb25mCnN1ZG8gdG91Y2ggL2V0Yy9xdWFnZ2EvcmlwbmdkLmNvbmYKc3VkbyB0b3VjaCAvZXRjL3F1YWdnYS92dHlzaC5jb25mCnN1ZG8gdG91Y2ggL2V0Yy9xdWFnZ2EvemVicmEuY29uZgoKIyMgQ2hhbmdlIHRoZSBvd25lcnNoaXAgYW5kIHBlcm1pc3Npb24gZm9yIGNvbmZpZ3VyYXRpb24gZmlsZXMsIHVuZGVyIC9ldGMvcXVhZ2dhIGZvbGRlcgplY2hvICJhc3NpZ24gdG8gcXVhZ2dhIHVzZXIgdGhlIG93bmVyc2hpcCBvZiBjb25maWcgZmlsZXMiCnN1ZG8gY2hvd24gcXVhZ2dhOnF1YWdnYSAvZXRjL3F1YWdnYS9iYWJlbGQuY29uZiAmJiBzdWRvIGNobW9kIDY0MCAvZXRjL3F1YWdnYS9iYWJlbGQuY29uZgpzdWRvIGNob3duIHF1YWdnYTpxdWFnZ2EgL2V0Yy9xdWFnZ2EvYmdwZC5jb25mICYmIHN1ZG8gY2htb2QgNjQwIC9ldGMvcXVhZ2dhL2JncGQuY29uZgpzdWRvIGNob3duIHF1YWdnYTpxdWFnZ2EgL2V0Yy9xdWFnZ2EvaXNpc2QuY29uZiAmJiBzdWRvIGNobW9kIDY0MCAvZXRjL3F1YWdnYS9pc2lzZC5jb25mCnN1ZG8gY2hvd24gcXVhZ2dhOnF1YWdnYSAvZXRjL3F1YWdnYS9vc3BmNmQuY29uZiAmJiBzdWRvIGNobW9kIDY0MCAvZXRjL3F1YWdnYS9vc3BmNmQuY29uZgpzdWRvIGNob3duIHF1YWdnYTpxdWFnZ2EgL2V0Yy9xdWFnZ2Evb3NwZmQuY29uZiAmJiBzdWRvIGNobW9kIDY0MCAvZXRjL3F1YWdnYS9vc3BmZC5jb25mCnN1ZG8gY2hvd24gcXVhZ2dhOnF1YWdnYSAvZXRjL3F1YWdnYS9yaXBkLmNvbmYgJiYgc3VkbyBjaG1vZCA2NDAgL2V0Yy9xdWFnZ2EvcmlwZC5jb25mCnN1ZG8gY2hvd24gcXVhZ2dhOnF1YWdnYSAvZXRjL3F1YWdnYS9yaXBuZ2QuY29uZiAmJiBzdWRvIGNobW9kIDY0MCAvZXRjL3F1YWdnYS9yaXBuZ2QuY29uZgpzdWRvIGNob3duIHF1YWdnYTpxdWFnZ2F2dHkgL2V0Yy9xdWFnZ2EvdnR5c2guY29uZiAmJiBzdWRvIGNobW9kIDY2MCAvZXRjL3F1YWdnYS92dHlzaC5jb25mCnN1ZG8gY2hvd24gcXVhZ2dhOnF1YWdnYSAvZXRjL3F1YWdnYS96ZWJyYS5jb25mICYmIHN1ZG8gY2htb2QgNjQwIC9ldGMvcXVhZ2dhL3plYnJhLmNvbmYKCiMjIGluaXRpYWwgc3RhcnR1cCBjb25maWd1cmF0aW9uIGZvciBRdWFnZ2EgZGFlbW9ucyBhcmUgcmVxdWlyZWQKZWNobyAiU2V0dGluZyB1cCBkYWVtb24gc3RhcnR1cCBjb25maWciCmVjaG8gJ3plYnJhPXllcycgPiAvZXRjL3F1YWdnYS9kYWVtb25zCmVjaG8gJ2JncGQ9eWVzJyA+PiAvZXRjL3F1YWdnYS9kYWVtb25zCmVjaG8gJ29zcGZkPW5vJyA+PiAvZXRjL3F1YWdnYS9kYWVtb25zCmVjaG8gJ29zcGY2ZD1ubycgPj4gL2V0Yy9xdWFnZ2EvZGFlbW9ucwplY2hvICdyaXBkPW5vJyA+PiAvZXRjL3F1YWdnYS9kYWVtb25zCmVjaG8gJ3JpcG5nZD1ubycgPj4gL2V0Yy9xdWFnZ2EvZGFlbW9ucwplY2hvICdpc2lzZD1ubycgPj4gL2V0Yy9xdWFnZ2EvZGFlbW9ucwplY2hvICdiYWJlbGQ9bm8nID4+IC9ldGMvcXVhZ2dhL2RhZW1vbnMKCmVjaG8gImFkZCB6ZWJyYSBjb25maWciCmNhdCA8PEVPRiA+IC9ldGMvcXVhZ2dhL3plYnJhLmNvbmYKIQppbnRlcmZhY2UgZXRoMAohCmludGVyZmFjZSBsbwohCmlwIGZvcndhcmRpbmcKIQpsaW5lIHZ0eQohCkVPRgoKCmVjaG8gImFkZCBxdWFnZ2EgY29uZmlnIgpjYXQgPDxFT0YgPiAvZXRjL3F1YWdnYS9iZ3BkLmNvbmYKIQpyb3V0ZXIgYmdwICRhc25fcXVhZ2dhCiBiZ3Agcm91dGVyLWlkICRiZ3Bfcm91dGVySWQKIG5ldHdvcmsgJGJncF9uZXR3b3JrMQogbmVpZ2hib3IgJHJvdXRlc2VydmVyX0lQMSByZW1vdGUtYXMgNjU1MTUKIG5laWdoYm9yICRyb3V0ZXNlcnZlcl9JUDEgc29mdC1yZWNvbmZpZ3VyYXRpb24gaW5ib3VuZAogbmVpZ2hib3IgJHJvdXRlc2VydmVyX0lQMiByZW1vdGUtYXMgNjU1MTUKIG5laWdoYm9yICRyb3V0ZXNlcnZlcl9JUDIgc29mdC1yZWNvbmZpZ3VyYXRpb24gaW5ib3VuZAohCiBhZGRyZXNzLWZhbWlseSBpcHY2CiBleGl0LWFkZHJlc3MtZmFtaWx5CiBleGl0CiEKbGluZSB2dHkKIQpFT0YKCiMjIHRvIHN0YXJ0IGRhZW1vbnMgYXQgc3lzdGVtIHN0YXJ0dXAKZWNobyAiZW5hYmxlIHplYnJhIGFuZCBxdWFnZ2EgZGFlbW9ucyBhdCBzeXN0ZW0gc3RhcnR1cCIKc3lzdGVtY3RsIGVuYWJsZSB6ZWJyYS5zZXJ2aWNlCnN5c3RlbWN0bCBlbmFibGUgYmdwZC5zZXJ2aWNlCgojIyBydW4gdGhlIGRhZW1vbnMKZWNobyAic3RhcnQgemVicmEgYW5kIHF1YWdnYSBkYWVtb25zIgpzeXN0ZW1jdGwgc3RhcnQgemVicmEgCnN5c3RlbWN0bCBzdGFydCBiZ3BkCg=='
  }
}

module hubVm '../_modules/vm.bicep' = {
  name: 'hubVm'
  params: {
    location: location
    subnetId: hub.outputs.subnets[2].id
    vmName: 'hubVm'
  }
}

module bastion '../_modules/bastion.bicep' = {
  name: 'bastion'
  dependsOn: [
    routeServer
  ]
  params: {
    location: location
    name: 'bastion'
    subnetId: hub.outputs.subnets[1].id 
  }
}

